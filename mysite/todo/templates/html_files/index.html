<html>

<div>
    <h1>To-do List</h1>
</div>

<body>
<div id="tasks">
<script>
    // Load task list to home screen
    function loadList() {
        fetch('api/v1/tasks')
            .then(response => {
                if (!response.ok) {
                    throw Error(`${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                const html = data.items.map(task => {
                    return `<p id=${task.id}>ID: ${task.id}  ${task.task}
                        <button onclick= completeTask(${task.id})>
                            Complete Task </button>
                        <button onclick=upDate(${task.id})>
                            Update </button></p>`}).join('')
                document.querySelector('#tasks').insertAdjacentHTML('afterbegin', html);
            })
            .catch(error => {
                console.log(error);
            });
        };

    // Complete task
    function completeTask(id) {
        let url = 'home'
        fetch(`http://127.0.0.1:8000/api/v1/task/${id}`, {method: 'DELETE'})
            .then(response => {
            const div = document.getElementById(id);
            div.remove();
            });
        };

    // Post Task Feature
    function postTask(new_task) {
        document.getElementById('new_task').value = ''
        const newTask = new FormData();
        newTask.append('task', new_task);
        const data = JSON.stringify({'task': new_task})
        fetch('api/v1/tasks', {
            method: 'POST',
            body: data})
            .then(response => {
                if (!response.ok) {
                    throw Error(`${response.status}`);
                    }
                return response.json();
                })
            .then(data => {
                data = Object.keys(data).map(function(key)
                    {return data[key]});
                console.log(data)
                const html = data.slice(0, 1).map(task => {
                    return `<p id=${data[0]}>
                        ID: ${data[0]} ${data[1]}
                        <button onclick= completeTask(${data[0]})>
                            Complete Task </button>
                        <button onclick=upDate(${data[0]})>
                            Update </button>
                        </p>`}).join('')

                document.querySelector('#tasks').insertAdjacentHTML('beforeend', html);
            })
            .catch(error => {
                console.log(error);
            });
        };

    // Submit function
    function submit(text_box_val, id) {
        fetch(`api/v1/task/${id}`, {
            method: "PUT",
            body: text_box.value
        });
        getElementById("txtBox").remove();
        getElementById("submit").remove();
        getElementById(id).value = text_box_val;
    };

    // Update Feature
    function upDate(id) {
        const update_item = document.getElementById(id);
        const text_box = `<input id="txtBox" type="text" name="task_update"/>`;
        const submitButton = `<button id="submit" type="submit" onclick=
            submit(text_box.value, ${id})
            > Submit </button>`;
        const html = (text_box + submitButton);
        document.getElementById(id).insertAdjacentHTML('beforeend', html);
    };

    loadList()
</script>
</div>

<button type="submit" onclick=postTask(document.getElementById('new_task').value)>
    Add Task </button>
<input id="new_task" type="text" name="task_text"/>

<form action="api/v1/task/" method="GET">
    <input type="submit" value="ID Search"/>
    <input type="text" name="search_text"/>
</form>

</body>
</html>